---
title: "s02_explore_ethnicity_of_outliers"
output: html_document
editor_options: 
  chunk_output_type: console
---

started: AL26Apr2019  
last updated: AL30Aug2019  

# Summary  

Inputs:  
- WECARE-NFE only outliers: based on 1,634 variants x 715 samples ( 519BC = 258UBC + 260CBC and 197NFE)  
- Joined WECARE-NFE-KGEN eigenvectors: 3,219 samples = 715 wecare-nfe + 2,504 kgen  

Look where the WECARE-NFE only outliers are positioned in PCA plot based on the joined eigenvectors.  
Surprisingly, cases of eastern asia ancestry have not been picked up by WECARE-NFE PCA.  
So, a solution may be to exclude them manually.  

# Start_section

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

```{r set_width, echo=F}

#eval=F

options(width = 999)
# https://stackoverflow.com/questions/36845178/width-of-r-code-chunk-output-in-rmarkdown-files-knitr-ed-to-html

```

```{r start_section}

Sys.time()
rm(list=ls())
graphics.off()

library(knitr)
library(dplyr)
library(ggplot2)
library(plotly)

base_folder="/Users/alexey/Documents/wecare/ampliseq/v04_ampliseq_nfe/s15_add_PCs_exclude_outliers"

opts_knit$set(root.dir = base_folder)

options(stringsAsFactors = F)
options(warnPartialMatchArgs = T, 
        warnPartialMatchAttr = T, 
        warnPartialMatchDollar = T)

#options(error = browser()) # Type Q or c to exit, drop browser level
# https://support.rstudio.com/hc/en-us/articles/200713843?version=1.1.456&mode=desktop
# https://stackoverflow.com/questions/13052522/how-to-leave-the-r-browser-mode-in-the-console-window/13052588 

```

# Read_data  

```{r read_data}

# Sequencing data (for wecare phenotypes: case/control status)
source_folder="/Users/alexey/Documents/wecare/ampliseq/v04_ampliseq_nfe/s12_check_BRCA1_BRCA2_PALB2"
load(paste(source_folder, "s03_exclude_BRCA1_BCRA2_PALB2_carriers.RData", sep="/"))
base_folder="/Users/alexey/Documents/wecare/ampliseq/v04_ampliseq_nfe/s15_add_PCs_exclude_outliers"

source_folder="/Users/alexey/Documents/wecare/ampliseq/v04_ampliseq_nfe/s14_explore_wecare_1kg_PCA_plots/s03_all_variants_not_in_LD_971"

# Eigenvectors
eigenvectors_file <- paste(source_folder, "ampliseq_1kg_971_3219_100PCs.eigenvec", sep="/")
eigenvectors.df <- read.table(eigenvectors_file, header=T, sep="\t",quote="")

# 1kg phenotypes (ethnicity and gender)
kg_phenotypes_file <- paste(source_folder, "integrated_call_samples_v3.20130502.ALL.panel", sep="/")
kg_phenotypes.df <- read.table(kg_phenotypes_file, header=T)

# Clean-up
rm(source_folder, eigenvectors_file, kg_phenotypes_file, genotypes.mx, variants.df)

```

# Check data

```{r start_check}

# List of objects
ls()

# Expected number of samples in eigenvectors
2504+715

# Dimentions of objects
dim(eigenvectors.df)
dim(kg_phenotypes.df)
dim(phenotypes.df)

# Update eigenvectors
rownames(eigenvectors.df) <- eigenvectors.df$FID
eigenvectors.df <- eigenvectors.df[,-1]

```

# Remove re-processed NFE samples, merge eigenvectors and phenotypes  

```{r prepare_ampliseq_kgen_data}

# Make a table with IDs of overlapping NFE
eigenvectors.df[c(3022,3023),c("IID","PC1")]
nfe_pca <- eigenvectors.df$IID[3023:3219] # re-processed NFE added to Ampliseq
nfe_ampliseq <- sub("2:","",nfe_pca)
nfe.df <- data.frame(nfe_ampliseq, nfe_pca)

# Remove overlapping NFE from ampliseq-kgen eigenvectors
selected_samples <- ! eigenvectors.df$IID %in% nfe.df$nfe_pca
sum(selected_samples)
518+2504
eigenvectors_ampliseq_kgen.df <- eigenvectors.df[selected_samples,1:6]
"sample" -> colnames(eigenvectors_ampliseq_kgen.df)[1]

# Prepare ampliseq phenotypes 
# (for clarity of PCA plot wecare samples and controls were not separated)
phenotypes.df[c(518:519),c(1,2)]
phenotypes_ampliseq.df <- phenotypes.df[1:518,c("long_ids","cc")]
table(phenotypes_ampliseq.df$cc)

"WECARE" -> phenotypes_ampliseq.df$cc[phenotypes_ampliseq.df$cc==1] # This could be named as CBC
"WECARE" -> phenotypes_ampliseq.df$cc[phenotypes_ampliseq.df$cc==0] # This could be named as UBC
table(phenotypes_ampliseq.df$cc)
c("sample","group") -> colnames(phenotypes_ampliseq.df)

# Prepare kgen phenotypes
phenotypes_kgen.df <- kg_phenotypes.df[,c("sample","super_pop")]
c("sample","group") -> colnames(phenotypes_kgen.df)

# Merge kgen and Ampliseq phenotypes (latest will be on top in the plot)
phenotypes_ampliseq_kgen.df <- rbind(phenotypes_kgen.df,phenotypes_ampliseq.df)
table(phenotypes_ampliseq_kgen.df$group)

# Add eigenvectors to phenotypes
dim(phenotypes_ampliseq_kgen.df)
dim(eigenvectors_ampliseq_kgen.df)
eigenphen_ampliseq_kgen.df <- full_join(
  phenotypes_ampliseq_kgen.df, eigenvectors_ampliseq_kgen.df, by="sample")
dim(eigenphen_ampliseq_kgen.df)
head(eigenphen_ampliseq_kgen.df)
tail(eigenphen_ampliseq_kgen.df)

# Clean-up
rm(nfe_pca, nfe_ampliseq, selected_samples, eigenvectors_ampliseq_kgen.df, 
   phenotypes_ampliseq.df, phenotypes_ampliseq_kgen.df, nfe.df, phenotypes_kgen.df, 
   eigenvectors.df, kg_phenotypes.df, phenotypes.df)

```

# Read data about PC outliers

```{r read_wecare_pc_outliers}

# Read data with wecare-only PCa and outliers
load(paste(base_folder, "s01_add_PCs_1634_715.RData", sep="/"))

# Extract data about previously selected outliers (based on wecare only PCs: mean +/- 3sd)
outliers.df <- phenotypes.df %>% 
  filter(pc_outlier) %>% 
  select(long_ids)

wecare_pc_outlier <- eigenphen_ampliseq_kgen.df$sample %in% outliers.df$long_ids
sum(wecare_pc_outlier)

# Add column with outliers to the main table
eigenphen_ampliseq_kgen.df <- data.frame(eigenphen_ampliseq_kgen.df, wecare_pc_outlier)

# Clean up
rm(genotypes.mx, phenotypes.df, variants.df, outliers.df, wecare_pc_outlier)

```

# Make PCA plot

http://www.sthda.com/english/wiki/ggplot2-point-shapes  

```{r ampliseq_kgen_plot}

# Set outliers thresholds (manually selected on the basis of visual assessment of plots)
pc1_th <- 0.005
pc2_th <- 0.01

# Prepare vector fr colour scale
myColours <- c("EUR"="BLUE", "AFR"="YELLOW", "AMR"="GREEN",
               "SAS"="GREY", "EAS"="PINK", 
               "WECARE"="RED")

myColourScale <- scale_colour_manual(values=myColours)

# Static plot
ggplot(eigenphen_ampliseq_kgen.df, aes(PC1,PC2)) + 
  geom_point(aes(col=group, shape=wecare_pc_outlier)) +
  labs(title="PC1 vs PC2", x="PC1", y="PC2") +
  scale_shape_manual(values=c(16,4)) +
  geom_vline(xintercept=pc1_th, linetype="dashed", size=0.5) +
  geom_hline(yintercept=pc2_th, linetype="dashed", size=0.5) +
  myColourScale

# Interactive plot
plotly_group <- factor(eigenphen_ampliseq_kgen.df$group,
  levels=c("AFR","AMR","EAS","SAS","EUR","WECARE"))

g <- ggplot(eigenphen_ampliseq_kgen.df, aes(PC1,PC2)) + 
  geom_point(aes(col=plotly_group, shape=wecare_pc_outlier, text=sample)) +
  labs(title="PC1 vs PC2 (manual thresholds)", x="PC1", y="PC2") +
  scale_shape_manual(values=c(16,4)) + 
  geom_vline(xintercept=pc1_th, linetype="dashed", size=0.5) +
  geom_hline(yintercept=pc2_th, linetype="dashed", size=0.5) +
  myColourScale 

ggplotly(g, tooltip="text") # By default the tooltip would also show coordinates 

# Clean-up
rm(myColours, myColourScale, plotly_group, g)

```

# Manually select WECARE outliers

```{r manual_outliers}

manual_outliers.df <- eigenphen_ampliseq_kgen.df %>% 
  filter(PC1 > pc1_th | PC2 > pc2_th, group=="WECARE") %>% 
  select(sample, wecare_pc_outlier)

dim(manual_outliers.df)
manual_outliers.df
sum(manual_outliers.df$wecare_pc_outlier)

```

# Save results

```{r save_results}

save.image(paste(base_folder, "s02_explore_ethnicity_of_outliers.RData", sep="/"))

```

# Final_section

```{r final_section}

ls()
sessionInfo()
Sys.time()

```
